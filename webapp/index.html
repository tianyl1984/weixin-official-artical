<!DOCTYPE html>
<html>
	<head lang="zh">
		<meta charset="UTF-8">
		<title>电影更新列表</title>
		<script type="text/javascript" src="jquery-2.2.0.js"></script>
		<script type="text/javascript">
		
			(function($) {
				$.nano = function(template, data) {
					return template.replace(/\{([\w\.]*)\}/g, function(str, key) {
						var keys = key.split("."), value = data[keys.shift()];
						$.each(keys, function() {
							value = value[this];
						});
						return (value === null || value === undefined) ? "" : value;
					});
				};
			})(jQuery);
		
			$(function(){
				var date = new Date();
				for(var i = 0; i < 10;i++){
					var month = date.getMonth() + 1;
					var day = date.getDate();
					var val = date.getFullYear() + "/" + (month < 10 ? "0" + month : month) + "/" + (day < 10 ? "0" + day : day);
					$("#dateSel").append("<option value='" + val + "'>" + val + "</option>");
					date.setTime(date.getTime() - 24*60*60*1000);
				}
				changeDate();
			});
			
			function changeDate(){
				$("#contentDl").html("");
				var updateTime = $("#dateSel").val();
				$.ajax("/fm/newFilm?updateTime=" + updateTime,{
					dataType:"json",
					error:function(jqxhr){
						alert("error");
					},
					success:function(data){
						render(data);
					}
				});
			}
	
			function render(data){
				//test
				data1 = {
					"websites":[{"id":1,"name":"aaa"},{"id":2,"name":"bbb"}],
					"newFilms":{
						"1":[{"name":"a1","url":"http://aaa.com"},{"name":"a2","url":"http://aaa.com"}],
// 						"2":[]
					}
				}
				var dt = "<dt>{name}</dt>";
				var dd = "<dd><a href='{url}' target='_blank'>{name}</a></dd>";
				var html = "";
				for(var wsInx in data.websites){
					var ws = data.websites[wsInx];
					html += $.nano(dt,ws);
					if(!data.newFilms[""+ws.id]){
						html += $.nano("<dd>{name}</dd>",{"name":"no data"});
					}
					for(var nfInx in data.newFilms[""+ws.id]){
						var nf = data.newFilms[""+ws.id][nfInx];
						html += $.nano(dd,nf);
					}
				}
				$("#contentDl").html(html);
			}
			
		</script>
	</head>
	<body>
		<select id="dateSel" onchange="changeDate()"></select>
		<dl id="contentDl"></dl>
	</body>
</html>